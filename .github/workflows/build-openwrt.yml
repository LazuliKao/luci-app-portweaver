name: Build OpenWrt Packages

on:
  push:
    branches: [ main, master ]
    paths:
      - 'openwrt-portweaver/**'
      - 'luci-app-portweaver/**'
      - '.github/workflows/build-openwrt.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.target }}/${{ matrix.subtarget }} (${{ matrix.version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Release builds
          - version: '24.10.5'
            target: x86
            subtarget: 64
          - version: '24.10.5'
            target: bcm27xx
            subtarget: bcm2710
          - version: '24.10.5'
            target: bcm27xx
            subtarget: bcm2711
          - version: '24.10.5'
            target: bcm27xx
            subtarget: bcm2709
          - version: '24.10.5'
            target: ramips
            subtarget: mt7621
          - version: '24.10.5'
            target: ath79
            subtarget: generic
          - version: '24.10.5'
            target: bcm53xx
            subtarget: generic
          - version: '24.10.5'
            target: armsr
            subtarget: armv8
          # SNAPSHOT builds
          - version: 'SNAPSHOT'
            target: x86
            subtarget: 64
          - version: 'SNAPSHOT'
            target: bcm27xx
            subtarget: bcm2710
          - version: 'SNAPSHOT'
            target: bcm27xx
            subtarget: bcm2711

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Prepare custom feed
        run: |
          mkdir -p custom-feed
          cp -r openwrt-portweaver custom-feed/portweaver
          cp -r luci-app-portweaver custom-feed/luci-app-portweaver

      - name: Build with OpenWrt SDK
        uses: openwrt/gh-action-sdk@main
        env:
          EXTRA_FEEDS: src-link custom-feed ${{ github.workspace }}/custom-feed
          PACKAGES: portweaver luci-app-portweaver
          # V: s
        with:
          target: ${{ matrix.target }}
          subtarget: ${{ matrix.subtarget }}
          version: ${{ matrix.version }}

      - name: List built packages
        run: |
          ls -lh openwrt/bin/packages/*/custom-feed/ || true
          ls -lh openwrt/bin/packages/*/luci/ || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: portweaver-${{ matrix.version }}-${{ matrix.target }}-${{ matrix.subtarget }}
          path: |
            openwrt/bin/packages/*/custom-feed/*.ipk
            openwrt/bin/packages/*/luci/*.ipk
          if-no-files-found: error

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize Release Files
        run: |
          mkdir -p release
          find all-artifacts -name "*.ipk" -exec cp {} release/ \;
          cd release
          ls -lh

      - name: Generate Release Info
        id: release_info
        run: |
          echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
          echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: PortWeaver ${{ steps.release_info.outputs.date }}
          body: |
            ## PortWeaver OpenWrt Packages
            
            Built with OpenWrt SDK (24.10.5 and SNAPSHOT)
            
            ### Installation
            ```bash
            opkg install portweaver_*.ipk
            opkg install luci-app-portweaver_*.ipk
            ```
            
            ### Supported Architectures
            - x86_64
            - bcm27xx (Raspberry Pi series)
            - ramips/mt7621 (MT7621 routers)
            - ath79 (AR71xx/AR9xxx routers)
            - bcm53xx
            - armsr/armv8
            
            Built on: ${{ steps.release_info.outputs.date }}
          files: release/*.ipk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
